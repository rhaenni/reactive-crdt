{"version":3,"file":"yjs-reactive-bindings.umd.js","sources":["../src/observableProvider.ts","../src/types/array.ts","../src/types/doc.ts","../src/types/map.ts","../src/types/text.ts","../src/types/xml.ts","../src/index.ts"],"sourcesContent":["export type Atom = {\r\n  /**\r\n   * Invoke this method to notify mobx that your atom has been used somehow.\r\n   * Returns true if there is currently a reactive context.\r\n   */\r\n  reportObserved(implicitObserver?: any): boolean;\r\n  /**\r\n   * Invoke this method _after_ this method has changed to signal mobx that all its observers should invalidate.\r\n   */\r\n  reportChanged(): void;\r\n};\r\n\r\nlet customCreateAtom: typeof createAtom | undefined;\r\n\r\nexport function createAtom(\r\n  _name: string,\r\n  _onBecomeObservedHandler?: () => void,\r\n  _onBecomeUnobservedHandler?: () => void\r\n): Atom {\r\n  if (customCreateAtom) {\r\n    return customCreateAtom.apply(null, arguments as any);\r\n  } else {\r\n    throw new Error(\r\n      \"observable implementation not provided. Call useReactiveBindings, useVueBindings or useMobxBindings.\"\r\n    );\r\n  }\r\n}\r\n\r\nexport function useMobxBindings(mobx: any) {\r\n  customCreateAtom = mobx.createAtom;\r\n}\r\n\r\nexport var vueRef: any;\r\n\r\nexport function useVueBindings(vue: any) {\r\n  vueRef = vue;\r\n  customCreateAtom = function(name: any, obo: any) {\r\n    let id = 0;\r\n    const data = vue.reactive({ data: id });\r\n    const atom = {\r\n      reportObserved() {\r\n        return (data.data as any) as boolean;\r\n      },\r\n      reportChanged() {\r\n        data.data = ++id;\r\n      }\r\n    };\r\n    if (obo) {\r\n      obo();\r\n    }\r\n    return atom;\r\n  };\r\n}\r\n\r\nexport function useReactiveBindings(reactive: any) {\r\n  customCreateAtom = function(name, obo, obu) {\r\n    // TMP\r\n    const atom = reactive.createAtom(name);\r\n    if (obo) {\r\n      obo();\r\n    }\r\n    return atom;\r\n  };\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { Atom, createAtom } from \"../observableProvider\";\r\n\r\nconst arraysObserved = new WeakSet<Y.Array<any>>();\r\n\r\nexport function observeArray(array: Y.Array<any>) {\r\n  if (arraysObserved.has(array)) {\r\n    // already patched\r\n    return array;\r\n  }\r\n  arraysObserved.add(array);\r\n\r\n  let selfAtom: Atom | undefined;\r\n  const atoms = new Map<number, Atom>();\r\n\r\n  function reportSelfAtom() {\r\n    if (!selfAtom) {\r\n      const handler = (event: Y.YArrayEvent<any>) => {\r\n        if (\r\n          event.changes.added.size ||\r\n          event.changes.deleted.size ||\r\n          event.changes.keys.size ||\r\n          event.changes.delta.length\r\n        ) {\r\n          selfAtom!.reportChanged();\r\n        }\r\n      };\r\n      selfAtom = createAtom(\r\n        \"map\",\r\n        () => {\r\n          array.observe(handler);\r\n        },\r\n        () => {\r\n          array.unobserve(handler);\r\n        }\r\n      );\r\n    }\r\n    selfAtom.reportObserved((array as any)._implicitObserver);\r\n  }\r\n\r\n  function reportArrayElementAtom(key: number) {\r\n    let atom = atoms.get(key);\r\n\r\n    // possible optimization: only register a single handler for all keys\r\n    if (!atom) {\r\n      const handler = (event: Y.YArrayEvent<any>) => {\r\n        // TODO: detect key of changed element\r\n        // if (event.keys.has(key + \"\")) {\r\n        //   if (\r\n        //     event.changes.added.size ||\r\n        //     event.changes.deleted.size ||\r\n        //     event.changes.keys.size ||\r\n        //     event.changes.delta.length\r\n        //   ) {\r\n        atom!.reportChanged();\r\n        // }\r\n      };\r\n      atom = createAtom(\r\n        key + \"\",\r\n        () => {\r\n          array.observe(handler);\r\n        },\r\n        () => {\r\n          array.unobserve(handler);\r\n        }\r\n      );\r\n      atoms.set(key, atom);\r\n    }\r\n\r\n    atom.reportObserved((array as any)._implicitObserver);\r\n  }\r\n\r\n  const originalGet = array.get;\r\n\r\n  array.get = function (key: number) {\r\n    if (typeof key !== \"number\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    reportArrayElementAtom(key);\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = array[method];\r\n    array[method] = function () {\r\n      reportSelfAtom();\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"forEach\");\r\n  patch(\"toJSON\");\r\n  patch(\"toArray\");\r\n  patch(\"slice\");\r\n  patch(\"map\");\r\n\r\n  // TODO: length, iterator\r\n  return array;\r\n}\r\n","import * as Y from \"yjs\";\r\n\r\nconst docsObserved = new WeakSet<Y.Doc>();\r\n\r\n// TODO: add atoms, etc\r\nexport function observeDoc(doc: Y.Doc) {\r\n  if (docsObserved.has(doc)) {\r\n    // already patched\r\n    return doc;\r\n  }\r\n  docsObserved.add(doc);\r\n\r\n  const originalGet = doc.get;\r\n\r\n  doc.get = function (key: string) {\r\n    if (typeof key !== \"string\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  return doc;\r\n}\r\n","import { Atom, createAtom } from \"../observableProvider\";\r\nimport * as Y from \"yjs\";\r\n\r\nconst mapsObserved = new WeakSet<Y.Map<any>>();\r\n\r\nexport function observeMap(map: Y.Map<any>) {\r\n  if (mapsObserved.has(map)) {\r\n    // already patched\r\n    return map;\r\n  }\r\n  mapsObserved.add(map);\r\n  let selfAtom: Atom | undefined;\r\n  const atoms = new Map<string, Atom>();\r\n\r\n  function reportSelfAtom() {\r\n    if (!selfAtom) {\r\n      const handler = (event: Y.YMapEvent<any>) => {\r\n        if (\r\n          event.changes.added.size ||\r\n          event.changes.deleted.size ||\r\n          event.changes.keys.size ||\r\n          event.changes.delta.length\r\n        ) {\r\n          selfAtom!.reportChanged();\r\n        }\r\n      };\r\n      selfAtom = createAtom(\r\n        \"map\",\r\n        () => {\r\n          map.observe(handler);\r\n        },\r\n        () => {\r\n          map.unobserve(handler);\r\n        }\r\n      );\r\n    }\r\n    selfAtom.reportObserved((map as any)._implicitObserver);\r\n  }\r\n\r\n  function reportMapKeyAtom(key: string) {\r\n    let atom = atoms.get(key);\r\n\r\n    // possible optimization: only register a single handler for all keys\r\n    if (!atom) {\r\n      const handler = (event: Y.YMapEvent<any>) => {\r\n        if (event.keysChanged.has(key)) {\r\n          if (\r\n            event.changes.added.size ||\r\n            event.changes.deleted.size ||\r\n            event.changes.keys.size ||\r\n            event.changes.delta.length\r\n          ) {\r\n            atom!.reportChanged();\r\n          }\r\n        }\r\n      };\r\n      atom = createAtom(\r\n        key,\r\n        () => {\r\n          map.observe(handler);\r\n        },\r\n        () => {\r\n          map.unobserve(handler);\r\n        }\r\n      );\r\n      atoms.set(key, atom);\r\n    }\r\n\r\n    atom.reportObserved((map as any)._implicitObserver);\r\n  }\r\n\r\n  const originalGet = map.get;\r\n\r\n  map.get = function (key: string) {\r\n    if (typeof key !== \"string\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    reportMapKeyAtom(key);\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = map[method];\r\n    map[method] = function () {\r\n      reportSelfAtom();\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"values\");\r\n  patch(\"entries\");\r\n  patch(\"keys\");\r\n  patch(\"forEach\");\r\n  patch(\"toJSON\");\r\n\r\n  // TODO: has, iterator\r\n  return map;\r\n}\r\n","import { Atom, createAtom } from \"../observableProvider\";\r\nimport * as Y from \"yjs\";\r\n\r\nconst textAtoms = new WeakMap<Y.Text, Atom>();\r\n\r\nexport function observeText(value: Y.Text) {\r\n  let atom = textAtoms.get(value);\r\n  if (!atom) {\r\n    const handler = (_changes: Y.YTextEvent) => {\r\n      atom!.reportChanged();\r\n    };\r\n    atom = createAtom(\r\n      \"text\",\r\n      () => {\r\n        value.observe(handler);\r\n      },\r\n      () => {\r\n        value.unobserve(handler);\r\n      }\r\n    );\r\n  }\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = value[method];\r\n    value[method] = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"toString\");\r\n  patch(\"toJSON\");\r\n  return value;\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { Atom, createAtom } from \"../observableProvider\";\r\n\r\nconst xmlAtoms = new WeakMap<Y.XmlFragment | Y.XmlText, Atom>();\r\n\r\nexport function observeXml(value: Y.XmlFragment) {\r\n  let atom = xmlAtoms.get(value);\r\n  if (!atom) {\r\n    const handler = (event: Y.YXmlEvent) => {\r\n      if (\r\n        event.changes.added.size ||\r\n        event.changes.deleted.size ||\r\n        event.changes.keys.size ||\r\n        event.changes.delta.length\r\n      ) {\r\n        atom!.reportChanged();\r\n      }\r\n    };\r\n\r\n    atom = createAtom(\r\n      \"xml\",\r\n      () => {\r\n        value.observe(handler);\r\n      },\r\n      () => {\r\n        value.unobserve(handler);\r\n      }\r\n    );\r\n  }\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = value[method];\r\n    value[method] = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  function patchGetter(method: string) {\r\n    let target = value;\r\n    let descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n\r\n    // properties might be defined down the prototype chain (e.g., properties on XmlFragment when working on an XmlElement)\r\n    if (!descriptor) {\r\n      target = Object.getPrototypeOf(target);\r\n      descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n    }\r\n\r\n    if (!descriptor) {\r\n      target = Object.getPrototypeOf(target);\r\n      descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n    }\r\n\r\n    if (!descriptor) {\r\n      throw new Error(\"property not found\");\r\n    }\r\n\r\n    const originalFunction = descriptor.get!;\r\n    descriptor.get = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n    Object.defineProperty(target, method, descriptor);\r\n  }\r\n\r\n  patch(\"toString\");\r\n  patch(\"toDOM\");\r\n  patch(\"toArray\");\r\n  patch(\"getAttribute\");\r\n  patchGetter(\"firstChild\");\r\n\r\n  return value;\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { observeArray } from \"./types/array\";\r\nimport { observeDoc } from \"./types/doc\";\r\nimport { observeMap } from \"./types/map\";\r\nimport { observeText } from \"./types/text\";\r\nimport { observeXml } from \"./types/xml\";\r\n\r\nexport function isYType(element: any) {\r\n  return element instanceof Y.AbstractType || Object.prototype.hasOwnProperty.call(element, \"autoLoad\"); // detect subdocs. Is there a better way for this?\r\n}\r\n\r\nexport function observeYJS(element: Y.AbstractType<any> | Y.Doc) {\r\n  if (element instanceof Y.XmlText) {\r\n    return observeText(element);\r\n  } else if (element instanceof Y.Text) {\r\n    return observeText(element);\r\n  } else if (element instanceof Y.Array) {\r\n    return observeArray(element);\r\n  } else if (element instanceof Y.Map) {\r\n    return observeMap(element);\r\n  } else if (element instanceof Y.Doc || Object.prototype.hasOwnProperty.call(element, \"autoLoad\")) {\r\n    // subdoc. Ok way to detect this?\r\n    return observeDoc((element as any) as Y.Doc);\r\n  } else if (element instanceof Y.XmlFragment) {\r\n    return observeXml(element);\r\n  } else if (element instanceof Y.XmlElement) {\r\n    return observeXml(element);\r\n  } else {\r\n    if (element._item === null && element._start === null) {\r\n      // console.warn(\"edge case\");\r\n    } else {\r\n      // throw new Error(\"not yet supported\");\r\n    }\r\n  }\r\n  return element;\r\n}\r\n\r\nexport function makeYJSObservable() {\r\n  Y.observeTypeCreated(el => {\r\n    observeYJS(el);\r\n  });\r\n}\r\n\r\nexport { useMobxBindings, useReactiveBindings, useVueBindings, vueRef } from \"./observableProvider\";\r\nexport { observeText, observeMap, observeDoc };\r\n"],"names":["customCreateAtom","createAtom","_name","_onBecomeObservedHandler","_onBecomeUnobservedHandler","apply","arguments","Error","useMobxBindings","mobx","vueRef","useVueBindings","vue","name","obo","id","data","reactive","atom","reportObserved","reportChanged","useReactiveBindings","obu","arraysObserved","WeakSet","observeArray","array","has","add","selfAtom","atoms","Map","reportSelfAtom","handler","event","changes","added","size","deleted","keys","delta","length","observe","unobserve","_implicitObserver","reportArrayElementAtom","key","get","set","originalGet","ret","Reflect","patch","method","originalFunction","docsObserved","observeDoc","doc","mapsObserved","observeMap","map","reportMapKeyAtom","keysChanged","textAtoms","WeakMap","observeText","value","_changes","xmlAtoms","observeXml","patchGetter","target","descriptor","Object","getOwnPropertyDescriptor","getPrototypeOf","defineProperty","isYType","element","Y","AbstractType","prototype","hasOwnProperty","call","observeYJS","XmlText","Text","Array","Doc","XmlFragment","XmlElement","makeYJSObservable","observeTypeCreated","el"],"mappings":"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"}