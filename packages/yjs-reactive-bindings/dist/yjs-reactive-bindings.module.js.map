{"version":3,"file":"yjs-reactive-bindings.module.js","sources":["../src/observableProvider.ts","../src/types/array.ts","../src/types/doc.ts","../src/types/map.ts","../src/types/text.ts","../src/types/xml.ts","../src/index.ts"],"sourcesContent":["export type Atom = {\r\n  /**\r\n   * Invoke this method to notify mobx that your atom has been used somehow.\r\n   * Returns true if there is currently a reactive context.\r\n   */\r\n  reportObserved(implicitObserver?: any): boolean;\r\n  /**\r\n   * Invoke this method _after_ this method has changed to signal mobx that all its observers should invalidate.\r\n   */\r\n  reportChanged(): void;\r\n};\r\n\r\nlet customCreateAtom: typeof createAtom | undefined;\r\n\r\nexport function createAtom(\r\n  _name: string,\r\n  _onBecomeObservedHandler?: () => void,\r\n  _onBecomeUnobservedHandler?: () => void\r\n): Atom {\r\n  if (customCreateAtom) {\r\n    return customCreateAtom.apply(null, arguments as any);\r\n  } else {\r\n    throw new Error(\r\n      \"observable implementation not provided. Call useReactiveBindings, useVueBindings or useMobxBindings.\"\r\n    );\r\n  }\r\n}\r\n\r\nexport function useMobxBindings(mobx: any) {\r\n  customCreateAtom = mobx.createAtom;\r\n}\r\n\r\nexport var vueRef: any;\r\n\r\nexport function useVueBindings(vue: any) {\r\n  vueRef = vue;\r\n  customCreateAtom = function(name: any, obo: any) {\r\n    let id = 0;\r\n    const data = vue.reactive({ data: id });\r\n    const atom = {\r\n      reportObserved() {\r\n        return (data.data as any) as boolean;\r\n      },\r\n      reportChanged() {\r\n        data.data = ++id;\r\n      }\r\n    };\r\n    if (obo) {\r\n      obo();\r\n    }\r\n    return atom;\r\n  };\r\n}\r\n\r\nexport function useReactiveBindings(reactive: any) {\r\n  customCreateAtom = function(name, obo, obu) {\r\n    // TMP\r\n    const atom = reactive.createAtom(name);\r\n    if (obo) {\r\n      obo();\r\n    }\r\n    return atom;\r\n  };\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { Atom, createAtom } from \"../observableProvider\";\r\n\r\nconst arraysObserved = new WeakSet<Y.Array<any>>();\r\n\r\nexport function observeArray(array: Y.Array<any>) {\r\n  if (arraysObserved.has(array)) {\r\n    // already patched\r\n    return array;\r\n  }\r\n  arraysObserved.add(array);\r\n\r\n  let selfAtom: Atom | undefined;\r\n  const atoms = new Map<number, Atom>();\r\n\r\n  function reportSelfAtom() {\r\n    if (!selfAtom) {\r\n      const handler = (event: Y.YArrayEvent<any>) => {\r\n        if (\r\n          event.changes.added.size ||\r\n          event.changes.deleted.size ||\r\n          event.changes.keys.size ||\r\n          event.changes.delta.length\r\n        ) {\r\n          selfAtom!.reportChanged();\r\n        }\r\n      };\r\n      selfAtom = createAtom(\r\n        \"map\",\r\n        () => {\r\n          array.observe(handler);\r\n        },\r\n        () => {\r\n          array.unobserve(handler);\r\n        }\r\n      );\r\n    }\r\n    selfAtom.reportObserved((array as any)._implicitObserver);\r\n  }\r\n\r\n  function reportArrayElementAtom(key: number) {\r\n    let atom = atoms.get(key);\r\n\r\n    // possible optimization: only register a single handler for all keys\r\n    if (!atom) {\r\n      const handler = (event: Y.YArrayEvent<any>) => {\r\n        // TODO: detect key of changed element\r\n        // if (event.keys.has(key + \"\")) {\r\n        //   if (\r\n        //     event.changes.added.size ||\r\n        //     event.changes.deleted.size ||\r\n        //     event.changes.keys.size ||\r\n        //     event.changes.delta.length\r\n        //   ) {\r\n        atom!.reportChanged();\r\n        // }\r\n      };\r\n      atom = createAtom(\r\n        key + \"\",\r\n        () => {\r\n          array.observe(handler);\r\n        },\r\n        () => {\r\n          array.unobserve(handler);\r\n        }\r\n      );\r\n      atoms.set(key, atom);\r\n    }\r\n\r\n    atom.reportObserved((array as any)._implicitObserver);\r\n  }\r\n\r\n  const originalGet = array.get;\r\n\r\n  array.get = function (key: number) {\r\n    if (typeof key !== \"number\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    reportArrayElementAtom(key);\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = array[method];\r\n    array[method] = function () {\r\n      reportSelfAtom();\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"forEach\");\r\n  patch(\"toJSON\");\r\n  patch(\"toArray\");\r\n  patch(\"slice\");\r\n  patch(\"map\");\r\n\r\n  // TODO: length, iterator\r\n  return array;\r\n}\r\n","import * as Y from \"yjs\";\r\n\r\nconst docsObserved = new WeakSet<Y.Doc>();\r\n\r\n// TODO: add atoms, etc\r\nexport function observeDoc(doc: Y.Doc) {\r\n  if (docsObserved.has(doc)) {\r\n    // already patched\r\n    return doc;\r\n  }\r\n  docsObserved.add(doc);\r\n\r\n  const originalGet = doc.get;\r\n\r\n  doc.get = function (key: string) {\r\n    if (typeof key !== \"string\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  return doc;\r\n}\r\n","import { Atom, createAtom } from \"../observableProvider\";\r\nimport * as Y from \"yjs\";\r\n\r\nconst mapsObserved = new WeakSet<Y.Map<any>>();\r\n\r\nexport function observeMap(map: Y.Map<any>) {\r\n  if (mapsObserved.has(map)) {\r\n    // already patched\r\n    return map;\r\n  }\r\n  mapsObserved.add(map);\r\n  let selfAtom: Atom | undefined;\r\n  const atoms = new Map<string, Atom>();\r\n\r\n  function reportSelfAtom() {\r\n    if (!selfAtom) {\r\n      const handler = (event: Y.YMapEvent<any>) => {\r\n        if (\r\n          event.changes.added.size ||\r\n          event.changes.deleted.size ||\r\n          event.changes.keys.size ||\r\n          event.changes.delta.length\r\n        ) {\r\n          selfAtom!.reportChanged();\r\n        }\r\n      };\r\n      selfAtom = createAtom(\r\n        \"map\",\r\n        () => {\r\n          map.observe(handler);\r\n        },\r\n        () => {\r\n          map.unobserve(handler);\r\n        }\r\n      );\r\n    }\r\n    selfAtom.reportObserved((map as any)._implicitObserver);\r\n  }\r\n\r\n  function reportMapKeyAtom(key: string) {\r\n    let atom = atoms.get(key);\r\n\r\n    // possible optimization: only register a single handler for all keys\r\n    if (!atom) {\r\n      const handler = (event: Y.YMapEvent<any>) => {\r\n        if (event.keysChanged.has(key)) {\r\n          if (\r\n            event.changes.added.size ||\r\n            event.changes.deleted.size ||\r\n            event.changes.keys.size ||\r\n            event.changes.delta.length\r\n          ) {\r\n            atom!.reportChanged();\r\n          }\r\n        }\r\n      };\r\n      atom = createAtom(\r\n        key,\r\n        () => {\r\n          map.observe(handler);\r\n        },\r\n        () => {\r\n          map.unobserve(handler);\r\n        }\r\n      );\r\n      atoms.set(key, atom);\r\n    }\r\n\r\n    atom.reportObserved((map as any)._implicitObserver);\r\n  }\r\n\r\n  const originalGet = map.get;\r\n\r\n  map.get = function (key: string) {\r\n    if (typeof key !== \"string\") {\r\n      throw new Error(\"unexpected\");\r\n    }\r\n    reportMapKeyAtom(key);\r\n    const ret = Reflect.apply(originalGet, this, arguments);\r\n    return ret;\r\n  };\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = map[method];\r\n    map[method] = function () {\r\n      reportSelfAtom();\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"values\");\r\n  patch(\"entries\");\r\n  patch(\"keys\");\r\n  patch(\"forEach\");\r\n  patch(\"toJSON\");\r\n\r\n  // TODO: has, iterator\r\n  return map;\r\n}\r\n","import { Atom, createAtom } from \"../observableProvider\";\r\nimport * as Y from \"yjs\";\r\n\r\nconst textAtoms = new WeakMap<Y.Text, Atom>();\r\n\r\nexport function observeText(value: Y.Text) {\r\n  let atom = textAtoms.get(value);\r\n  if (!atom) {\r\n    const handler = (_changes: Y.YTextEvent) => {\r\n      atom!.reportChanged();\r\n    };\r\n    atom = createAtom(\r\n      \"text\",\r\n      () => {\r\n        value.observe(handler);\r\n      },\r\n      () => {\r\n        value.unobserve(handler);\r\n      }\r\n    );\r\n  }\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = value[method];\r\n    value[method] = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  patch(\"toString\");\r\n  patch(\"toJSON\");\r\n  return value;\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { Atom, createAtom } from \"../observableProvider\";\r\n\r\nconst xmlAtoms = new WeakMap<Y.XmlFragment | Y.XmlText, Atom>();\r\n\r\nexport function observeXml(value: Y.XmlFragment) {\r\n  let atom = xmlAtoms.get(value);\r\n  if (!atom) {\r\n    const handler = (event: Y.YXmlEvent) => {\r\n      if (\r\n        event.changes.added.size ||\r\n        event.changes.deleted.size ||\r\n        event.changes.keys.size ||\r\n        event.changes.delta.length\r\n      ) {\r\n        atom!.reportChanged();\r\n      }\r\n    };\r\n\r\n    atom = createAtom(\r\n      \"xml\",\r\n      () => {\r\n        value.observe(handler);\r\n      },\r\n      () => {\r\n        value.unobserve(handler);\r\n      }\r\n    );\r\n  }\r\n\r\n  function patch(method: string) {\r\n    const originalFunction = value[method];\r\n    value[method] = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n  }\r\n\r\n  function patchGetter(method: string) {\r\n    let target = value;\r\n    let descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n\r\n    // properties might be defined down the prototype chain (e.g., properties on XmlFragment when working on an XmlElement)\r\n    if (!descriptor) {\r\n      target = Object.getPrototypeOf(target);\r\n      descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n    }\r\n\r\n    if (!descriptor) {\r\n      target = Object.getPrototypeOf(target);\r\n      descriptor = Object.getOwnPropertyDescriptor(target, method)!;\r\n    }\r\n\r\n    if (!descriptor) {\r\n      throw new Error(\"property not found\");\r\n    }\r\n\r\n    const originalFunction = descriptor.get!;\r\n    descriptor.get = function() {\r\n      atom!.reportObserved(this._implicitObserver);\r\n      const ret = Reflect.apply(originalFunction, this, arguments);\r\n      return ret;\r\n    };\r\n    Object.defineProperty(target, method, descriptor);\r\n  }\r\n\r\n  patch(\"toString\");\r\n  patch(\"toDOM\");\r\n  patch(\"toArray\");\r\n  patch(\"getAttribute\");\r\n  patchGetter(\"firstChild\");\r\n\r\n  return value;\r\n}\r\n","import * as Y from \"yjs\";\r\nimport { observeArray } from \"./types/array\";\r\nimport { observeDoc } from \"./types/doc\";\r\nimport { observeMap } from \"./types/map\";\r\nimport { observeText } from \"./types/text\";\r\nimport { observeXml } from \"./types/xml\";\r\n\r\nexport function isYType(element: any) {\r\n  return element instanceof Y.AbstractType || Object.prototype.hasOwnProperty.call(element, \"autoLoad\"); // detect subdocs. Is there a better way for this?\r\n}\r\n\r\nexport function observeYJS(element: Y.AbstractType<any> | Y.Doc) {\r\n  if (element instanceof Y.XmlText) {\r\n    return observeText(element);\r\n  } else if (element instanceof Y.Text) {\r\n    return observeText(element);\r\n  } else if (element instanceof Y.Array) {\r\n    return observeArray(element);\r\n  } else if (element instanceof Y.Map) {\r\n    return observeMap(element);\r\n  } else if (element instanceof Y.Doc || Object.prototype.hasOwnProperty.call(element, \"autoLoad\")) {\r\n    // subdoc. Ok way to detect this?\r\n    return observeDoc((element as any) as Y.Doc);\r\n  } else if (element instanceof Y.XmlFragment) {\r\n    return observeXml(element);\r\n  } else if (element instanceof Y.XmlElement) {\r\n    return observeXml(element);\r\n  } else {\r\n    if (element._item === null && element._start === null) {\r\n      // console.warn(\"edge case\");\r\n    } else {\r\n      // throw new Error(\"not yet supported\");\r\n    }\r\n  }\r\n  return element;\r\n}\r\n\r\nexport function makeYJSObservable() {\r\n  Y.observeTypeCreated(el => {\r\n    observeYJS(el);\r\n  });\r\n}\r\n\r\nexport { useMobxBindings, useReactiveBindings, useVueBindings, vueRef } from \"./observableProvider\";\r\nexport { observeText, observeMap, observeDoc };\r\n"],"names":["customCreateAtom","createAtom","_name","_onBecomeObservedHandler","_onBecomeUnobservedHandler","apply","arguments","Error","useMobxBindings","mobx","vueRef","useVueBindings","vue","name","obo","id","data","reactive","atom","reportObserved","reportChanged","useReactiveBindings","obu","arraysObserved","WeakSet","observeArray","array","has","add","selfAtom","atoms","Map","reportSelfAtom","handler","event","changes","added","size","deleted","keys","delta","length","observe","unobserve","_implicitObserver","reportArrayElementAtom","key","get","set","originalGet","ret","Reflect","patch","method","originalFunction","docsObserved","observeDoc","doc","mapsObserved","observeMap","map","reportMapKeyAtom","keysChanged","textAtoms","WeakMap","observeText","value","_changes","xmlAtoms","observeXml","patchGetter","target","descriptor","Object","getOwnPropertyDescriptor","getPrototypeOf","defineProperty","isYType","element","Y","AbstractType","prototype","hasOwnProperty","call","observeYJS","XmlText","Text","Array","Doc","XmlFragment","XmlElement","makeYJSObservable","observeTypeCreated","el"],"mappings":"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"}